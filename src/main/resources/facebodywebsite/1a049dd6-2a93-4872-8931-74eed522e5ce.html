<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />
<title>活动报名</title>
<link href="js/swiper-4.5.1/swiper-Swiper4/dist/css/swiper.min.css"; rel="stylesheet">
<link href="js/bootstrap-3.3.7-dist/css/bootstrap.min.css"; rel="stylesheet">
<script src="js/jquery.min.js";></script>
<script src="js/swiper-4.5.1/swiper-Swiper4/dist/js/swiper.min.js";></script>
<script src="js/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script>
<style type="text/css">
  *{
    margin: 0;
    padding: 0;
    font-family: 微软雅黑!important;
  }
  html{
      width: 100%;
      background-repeat:no-repeat;
      touch-action:none;
      touch-action:pan-y;
      /* pointer-events: auto;
      touch-action: manipulation; */
     
  }
  body{
      background-color:#130E4E;
      /* background-size:100%; */
      color: white;
  }
  
</style>
</head>
<body style="background-image: url(images-14/slide2.jpg);background-repeat:no-repeat;background-size:100% 100%;-moz-background-size:100% 100%;">
  <div class="row" style="margin-top:20px">
    <div class="col-lg-3 col-md-3 col-xs-0" >
    </div>

    <div class="col-lg-6 col-md-6 col-xs-12" style="padding:25px;margin-bottom: 30px;">
        <div style="width: 73%;margin: 0 auto;">
            <span style="font-size: 23px;" id="mytitle"></span><br>
            <span id="mydetail">
                
            </span>
        </div>
        
        <form role="form" class="form-horizontal" style="margin-left:50px;margin-top: 20px;">
          <div class="form-group form-group-xs">
            <label  style="width: 100px;margin-left:15px;float: left;">报名时间:</label>
            <div style="float: left;margin-left: -30px;">
                <span id="signtime"></span>
            </div>
          </div>
          <div class="form-group form-group-xs">
            <label  style="width: 100px;margin-left:15px;float: left;">活动时间:</label>
            <div style="float: left;margin-left: -30px;" >
                <span id="starttime"></span>
            </div>
          </div>
            <div class="form-group form-group-xs">
                <label for="hospitalName" class="control-label " style="width: 100px;margin-left:15px;">姓名(必填):</label><br>
                <div class="col-xs-5">
                    <input type="text" class="form-control" style="width: 240px;border:0px" name="name" id="name" placeholder="" required="required" />
                </div>
            </div>
            <div class="form-group form-group-xs">
              <label for="mobileNum" class="control-label " style="width: 100px;display: block;float: left;margin-left: 15px;margin-top: 8px;">性别(必填):</label>
              <div class="col-xs-5" style="float: left;">
                  <label class="radio-inline">
                      <input type="radio" name="optionsRadiosinline" id="sex" value="1" checked> 男
                  </label>
                  &nbsp;&nbsp;&nbsp;
                  <label class="radio-inline">
                      <input type="radio" name="optionsRadiosinline" id="sex"  value="0"> 女
                  </label>
              </div>
          </div>
            <div class="form-group form-group-xs">
                <label for="username" class="control-label " style="width: 100px;margin-left:15px;">手机号(必填):</label><br>
                <div class="col-xs-5">
                    <input type="text" class="form-control" style="width: 240px;" name="phone" id="phone" placeholder="" required="required"/>
                </div>
            </div>
            
            <div class="form-group form-group-xs">
                <label for="mobileNum" class="control-label " style="width: 100px;margin-left:15px;">人数(必填):</label><br>
                <div class="col-xs-5">
                    <input type="text" class="form-control" style="width: 240px;" name="city" id="number" placeholder="1" required="required" maxlength="11"/>
                </div>
            </div>
            <div class="form-group form-group-xs">
                <label for="mobileNum" class="control-label" style="width: 100px;margin-left:15px;">备注:</label><br>
                <div class="col-xs-5">
                    <input type="text" class="form-control" style="width: 240px;" name="sqsm" id="remarks" placeholder="" required="required" maxlength="11"/>
                </div>
            </div>
            <div class="form-group form-group-xs">
                <label  style="width: 100px;margin-left:15px;float: left;">报名费:</label>
                <div style="float: left;margin-left: -30px;" id="fee">
                    <!-- <input type="text" class="form-control" style="width: 250px;" name="sqsm" id="sqsm" placeholder="" required="required" maxlength="11"/> -->
                    <span id="myfee">30</span>
                </div>
            </div>

            <div class="form-group form-group-xs">
                <div class="col-xs-2 col-xs-offset-2">
                    <div id="tijiao" name="tijiao" class="btn btn-success btn-xs" style="width: 80px;height: 30px;text-align: center;line-height: 25px;margin-left:35px;margin-top:20px;">提交</div>
                </div>
            </div>
        </form>

    </div>

    <div class="col-lg-3 col-md-3 col-xs-0"  >
    </div>
</div>

</body>
</html>
<script>
  jQuery(function($) {var activityid=15923720349168872;var name='活动13';var detail='aaa';var fee=0.01;var starttime='2020-6-29~2020-6-30';var signtime='2020-6-2~2020-6-17';document.getElementById("mytitle").innerHTML=name
    document.getElementById("mydetail").innerHTML=detail
    document.getElementById("myfee").innerHTML=fee
    document.getElementById("starttime").innerHTML=starttime
    document.getElementById("signtime").innerHTML=signtime
    var signendtime=signtime.split('~')[1]

    var url = location.search; //获取url中"?"符后的字串
    var openid=''
    var theRequest = new Object();

    if (url.indexOf("?") != -1) {

        var str = url.substr(1);

        strs = str.split("&");

        for(var i = 0; i < strs.length; i ++) {

          theRequest[strs[i].split("=")[0]]=(strs[i].split("=")[1]);

        }

    }
    
    const local = window.location.href

    if (theRequest.code == null || theRequest.code === '') {
        var time = (new Date()).valueOf()
        window.location.href = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=' + 'wx1b98935219078af2' +
            '&redirect_uri=' + encodeURIComponent(local)+"?time="+time + '&response_type=code&scope=snsapi_userinfo&state=1#wechat_redirect'
    }


    function isPhoneNum(str){
        var myreg=/^[1][3,4,5,6,7,8][0-9]{9}$/;
        if (!myreg.test(str)) {
            return false;
        }else{
            return true;
        }
    }

    $('#tijiao').click(function(){
      var username,phone,sex,numbers=1,remarks,totalfee;
      var orderid=(new Date()).valueOf()+''+Math.ceil(Math.random()*10000) 
      if(new Date(new Date(signendtime).getTime()+86400000)>=new Date()){
      if($("#name").val()!=''&&$("#phone").val()!=''&&$("#sex").val()!=''){
        if(isPhoneNum($("#phone").val())){
          username=$("#name").val()
          phone=$("#phone").val()
          sex=$("#sex").val()
          if($("#number").val()!=''){
            if(typeof (parseInt($("#number").val()))=='number'){ 
              numbers=$("#number").val()
              totalfee = fee*numbers
              remarks=$("#remarks").val()
              sex=$("#sex").val()
              if(fee==0){
                $.ajax({
                  type : "POST",
                  url : "http://106.14.162.18:8080/hi/main?hi=24CQRLLN9PBA",
                  dataType : "text",
                  data : {id:orderid,name:username,tel:phone,sex:sex,number:numbers,activityid:activityid},
                  success : function(data) {
                    alert('报名成功')
                    parent.WeixinJSBridge.call('closeWindow');
                    window.close();
                  }
                })
              }else{
                $.ajax({
                  type : "POST",
                  url : "http://106.14.162.18:8080/hi/main?hi=24CQ2GUXV3CB",
                  dataType : "text",
                  data : {id:orderid,name:username,tel:phone,sex:sex,number:numbers,activityid:activityid,totalfee:totalfee},
                  success : function(data) {
                    $.ajax({
                      type : "POST",
                      url : "http://106.14.162.18:8081/getCode",
                      dataType : "text",
                      data : {code:theRequest.code},
                      success : function(e) {
                        openid=e
                        $.ajax({
                          type : "POST",
                          url : "http://106.14.162.18:8081/wxPay",
                          dataType : "text",
                          data : {id:orderid,sfprice:totalfee,openid:openid},
                          success : function(e) {
                            var myresult=JSON.parse(e) 
                            WeixinJSBridge.invoke(
                              'getBrandWCPayRequest', {
                                "appId":'wx1b98935219078af2',     //公众号名称，由商户传入     
                                "timeStamp":myresult.timeStamp,         //时间戳，自1970年以来的秒数     
                                "nonceStr":myresult.nonceStr, //随机串     
                                "package":myresult.package,     
                                "signType":"MD5",         //微信签名方式：     
                                "paySign":myresult.paySign //微信签名 
                              },
                              function(res){
                              if(res.err_msg == "get_brand_wcpay_request:ok" ){
                          
                                $.ajax({
                                  type : "POST",
                                  url : "http://106.14.162.18:8080/hi/main?hi=24CQ2GUXV3Z0",
                                  dataType : "text",
                                  data : {id:orderid},
                                  success : function(data) {
                                   
                                    alert('报名成功')
                                    parent.WeixinJSBridge.call('closeWindow');
                                    window.close();
                                  }
                                })  
                              } 
                          });
                                
                          }
                        })
                      }
                    }) 
                  
                  }
                })
              }
            }else{
              alert('人数请填数字')
            }
          }else{
            totalfee=numbers*fee
            if(fee==0){
                $.ajax({
                  type : "POST",
                  url : "http://106.14.162.18:8080/hi/main?hi=24CQRLLN9PBA",
                  dataType : "text",
                  data : {id:orderid,name:username,tel:phone,sex:sex,number:numbers,activityid:activityid},
                  success : function(data) {
                    alert('报名成功')
                    parent.WeixinJSBridge.call('closeWindow');
                    window.close();
                  }
                })
              }else{
                $.ajax({
                  type : "POST",
                  url : "http://106.14.162.18:8080/hi/main?hi=24CQ2GUXV3CB",
                  dataType : "text",
                  data : {id:orderid,name:username,tel:phone,sex:sex,number:numbers,activityid:activityid,totalfee:totalfee},
                  success : function(data) {
                    $.ajax({
                      type : "POST",
                      url : "http://106.14.162.18:8081/getCode",
                      dataType : "text",
                      data : {code:theRequest.code},
                      success : function(e) {
                        openid=e
                        $.ajax({
                          type : "POST",
                          url : "http://106.14.162.18:8081/wxPay",
                          dataType : "text",
                          data : {id:orderid,sfprice:totalfee,openid:openid},
                          success : function(e) {
                            var myresult=JSON.parse(e) 
                            WeixinJSBridge.invoke(
                              'getBrandWCPayRequest', {
                                "appId":'wx1b98935219078af2',     //公众号名称，由商户传入     
                                "timeStamp":myresult.timeStamp,         //时间戳，自1970年以来的秒数     
                                "nonceStr":myresult.nonceStr, //随机串     
                                "package":myresult.package,     
                                "signType":"MD5",         //微信签名方式：     
                                "paySign":myresult.paySign //微信签名 
                              },
                              function(res){
                              if(res.err_msg == "get_brand_wcpay_request:ok" ){
                                $.ajax({
                                  type : "POST",
                                  url : "http://106.14.162.18:8080/hi/main?hi=24CQ2GUXV3Z0",
                                  dataType : "text",
                                  data : {id:orderid},
                                  success : function(data) {
                                    
                                    alert('报名成功')
                                    parent.WeixinJSBridge.call('closeWindow');
                                    window.close();
                                  }
                                })              
                              } 
                          });
                                
                          }
                        })
                      }
                    }) 
                  
                  }
                })
              }
          }
        }else{
          alert('请检查手机号是否有误')
        }
        
        
      }else{
        alert('检测到有未填信息')
      }
    }else{
      alert('报名已截止')
    }
      
    })
  })
 
    

</script>